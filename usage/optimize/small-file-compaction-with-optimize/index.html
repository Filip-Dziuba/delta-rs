
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://github.com/delta-io/delta-rs/usage/optimize/small-file-compaction-with-optimize/">
      
      
        <link rel="prev" href="../../deleting-rows-from-delta-lake-table/">
      
      
        <link rel="next" href="../delta-lake-z-order/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.5">
    
    
      
        <title>Small file compaction - Delta Lake Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.6a10b989.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_markdown_exec_ansi.css">
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#delta-lake-small-file-compaction-with-optimize" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Delta Lake Documentation" class="md-header__button md-logo" aria-label="Delta Lake Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Delta Lake Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Small file compaction
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/delta-io/delta-rs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    delta-io/delta-rs
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../installation/" class="md-tabs__link">
          
  
  Usage

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../api/delta_table/" class="md-tabs__link">
          
  
  API Reference

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../integrations/delta-lake-pandas/" class="md-tabs__link">
          
  
  Integrations

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Delta Lake Documentation" class="md-nav__button md-logo" aria-label="Delta Lake Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Delta Lake Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/delta-io/delta-rs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    delta-io/delta-rs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Usage
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Usage
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../create-delta-lake-table/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Creating a table
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../loading-table/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Loading a table
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../appending-overwriting-delta-lake-table/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Append/overwrite tables
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../examining-table/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Examining a table
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../querying-delta-tables/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Querying a table
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../managing-tables/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Managing a table
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../writing-delta-tables/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Writing a table
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deleting-rows-from-delta-lake-table/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Deleting rows from a table
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_11" checked>
        
          
          <label class="md-nav__link" for="__nav_2_11" id="__nav_2_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Optimize
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_11_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_11">
            <span class="md-nav__icon md-icon"></span>
            Optimize
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Small file compaction
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Small file compaction
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#create-a-delta-table-with-small-files" class="md-nav__link">
    Create a Delta table with small files
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compact-small-files-in-the-delta-table-with-optimize" class="md-nav__link">
    Compact small files in the Delta table with optimize
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#handling-incremental-updates-with-optimize" class="md-nav__link">
    Handling incremental updates with optimize
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vacuuming-after-optimizing" class="md-nav__link">
    Vacuuming after optimizing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-causes-the-small-file-problem" class="md-nav__link">
    What causes the small file problem?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    Conclusion
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../delta-lake-z-order/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Z Order
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    API Reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/delta_table/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DeltaTable
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/schema/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Schema
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/storage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Storage
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Integrations
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Integrations
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../../integrations/delta-lake-pandas/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pandas
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#create-a-delta-table-with-small-files" class="md-nav__link">
    Create a Delta table with small files
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compact-small-files-in-the-delta-table-with-optimize" class="md-nav__link">
    Compact small files in the Delta table with optimize
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#handling-incremental-updates-with-optimize" class="md-nav__link">
    Handling incremental updates with optimize
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vacuuming-after-optimizing" class="md-nav__link">
    Vacuuming after optimizing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-causes-the-small-file-problem" class="md-nav__link">
    What causes the small file problem?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    Conclusion
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="delta-lake-small-file-compaction-with-optimize">Delta Lake small file compaction with optimize</h1>
<p>This post shows you how to perform small file compaction with using the <code>optimize</code> method.  This was added to the <code>DeltaTable</code> class in version 0.9.0.  This command rearranges the small files into larger files which will reduce the number of files and speed up queries.</p>
<p>This is very helpful for workloads that append frequently. For example, if you have a table that is appended to every 10 minutes, after a year you will have 52,560 files in the table. If the table is partitioned by another dimension, you will have 52,560 files per partition; with just 100 unique values that's millions of files. By running <code>optimize</code> periodically, you can reduce the number of files in the table to a more manageable number.</p>
<p>Typically, you will run optimize less frequently than you append data. If possible, you might run optimize once you know you have finished writing to a particular partition. For example, on a table partitioned by date, you might append data every 10 minutes, but only run optimize once a day at the end of the day. This will ensure you don't need to compact the same data twice.</p>
<p>This section will also teach you about how to use <code>vacuum</code> to physically remove files from storage that are no longer needed.  You’ll often want vacuum after running optimize to remove the small files from storage once they’ve been compacted into larger files.</p>
<p>Let’s start with an example to explain these key concepts.  All the code covered in this post is stored in <a href="https://github.com/delta-io/delta-examples/blob/master/notebooks/python-deltalake/deltalake_0_9_0.ipynb">this notebook</a> in case you’d like to follow along.</p>
<h2 id="create-a-delta-table-with-small-files">Create a Delta table with small files</h2>
<p>Let’s start by creating a Delta table with a lot of small files so we can demonstrate the usefulness of the <code>optimize</code> command.</p>
<p>Start by writing a function that generates on thousand rows of random data given a timestamp.</p>
<div class="highlight"><pre><span></span><code>def record_observations(date: datetime) -&gt; pa.Table:
    &quot;&quot;&quot;Pulls data for a certain datetime&quot;&quot;&quot;
    nrows = 1000
    return pa.table(
        {
            &quot;date&quot;: pa.array([date.date()] * nrows),
            &quot;timestamp&quot;: pa.array([date] * nrows),
            &quot;value&quot;: pc.random(nrows),
        }
    )
</code></pre></div>
<p>Let’s run this function and observe the output:</p>
<div class="highlight"><pre><span></span><code>record_observations(datetime(2021, 1, 1, 12)).to_pandas()

    date                timestamp   value
0   2021-01-01  2021-01-01 12:00:00 0.3186397383362023
1   2021-01-01  2021-01-01 12:00:00 0.04253766974259088
2   2021-01-01  2021-01-01 12:00:00 0.9355682965171573
…
999 2021-01-01  2021-01-01 12:00:00 0.23207037062879843
</code></pre></div>
<p>Let’s write 100 hours worth of data to the Delta table.</p>
<div class="highlight"><pre><span></span><code># Every hour starting at midnight on 2021-01-01
hours_iter = (datetime(2021, 1, 1) + timedelta(hours=i) for i in itertools.count())

# Write 100 hours worth of data
for timestamp in itertools.islice(hours_iter, 100):
    write_deltalake(
        &quot;observation_data&quot;,
        record_observations(timestamp),
        partition_by=[&quot;date&quot;],
        mode=&quot;append&quot;,
    )
</code></pre></div>
<p>This data was appended to the Delta table in 100 separate transactions, so the table will contain 100 transaction log entries and 100 data files.  You can see the number of files with the <code>files()</code> method.</p>
<div class="highlight"><pre><span></span><code>dt = DeltaTable(&quot;observation_data&quot;)
len(dt.files()) # 100
</code></pre></div>
<p>Here’s how the files are persisted in storage.</p>
<div class="highlight"><pre><span></span><code>observation_data
├── _delta_log
│   ├── 00000000000000000000.json
│   ├── …
│   └── 00000000000000000099.json
├── date=2021-01-01
│   ├── 0-cfe227c6-edd9-4369-a1b0-db4559a2e693-0.parquet
│   ├── …
│   ├── 23-a4ace29e-e73e-40a1-81d3-0f5dc13093de-0.parquet
├── date=2021-01-02
│   ├── 24-9698b456-66eb-4075-8732-fe56d81edb60-0.parquet
│   ├── …
│   └── 47-d3fce527-e018-4c02-8acd-a649f6f523d2-0.parquet
├── date=2021-01-03
│   ├── 48-fd90a7fa-5a14-42ed-9f59-9fe48d87899d-0.parquet
│   ├── …
│   └── 71-5f143ade-8ae2-4854-bdc5-61154175665f-0.parquet
├── date=2021-01-04
│   ├── 72-477c10fe-dc09-4087-80f0-56006e4a7911-0.parquet
│   ├── …
│   └── 95-1c92cbce-8af4-4fe4-9c11-832245cf4d40-0.parquet
└── date=2021-01-05
    ├── 96-1b878ee5-25fd-431a-bc3e-6dcacc96b470-0.parquet
    ├── …
    └── 99-9650ed63-c195-433d-a86b-9469088c14ba-0.parquet
</code></pre></div>
<p>Each of these Parquet files are tiny - they’re only 10 KB.  Let’s see how to compact these tiny files into larger files, which is more efficient for data queries.</p>
<h2 id="compact-small-files-in-the-delta-table-with-optimize">Compact small files in the Delta table with optimize</h2>
<p>Let’s run the optimize command to compact the existing small files into larger files:</p>
<div class="highlight"><pre><span></span><code>dt = DeltaTable(&quot;observation_data&quot;)

dt.optimize()
</code></pre></div>
<p>Here’s the output of the command:</p>
<div class="highlight"><pre><span></span><code>{&#39;numFilesAdded&#39;: 5,
 &#39;numFilesRemoved&#39;: 100,
 &#39;filesAdded&#39;: {&#39;min&#39;: 39000,
  &#39;max&#39;: 238282,
  &#39;avg&#39;: 198425.6,
  &#39;totalFiles&#39;: 5,
  &#39;totalSize&#39;: 992128},
 &#39;filesRemoved&#39;: {&#39;min&#39;: 10244,
  &#39;max&#39;: 10244,
  &#39;avg&#39;: 10244.0,
  &#39;totalFiles&#39;: 100,
  &#39;totalSize&#39;: 1024400},
 &#39;partitionsOptimized&#39;: 5,
 &#39;numBatches&#39;: 1,
 &#39;totalConsideredFiles&#39;: 100,
 &#39;totalFilesSkipped&#39;: 0,
 &#39;preserveInsertionOrder&#39;: True}
</code></pre></div>
<p>The optimize operation has added 5 new files and marked 100 exisitng files for removal (this is also known as “tombstoning” files).  It has compacted the 100 tiny files into 5 larger files.</p>
<p>Let’s append some more data to the Delta table and see how we can selectively run optimize on the new data that’s added.</p>
<h2 id="handling-incremental-updates-with-optimize">Handling incremental updates with optimize</h2>
<p>Let’s append another 24 hours of data to the Delta table:</p>
<div class="highlight"><pre><span></span><code>for timestamp in itertools.islice(hours_iter, 24):
    write_deltalake(
        dt,
        record_observations(timestamp),
        partition_by=[&quot;date&quot;],
        mode=&quot;append&quot;,
    )
</code></pre></div>
<p>We can use <code>get_add_actions()</code> to introspect the table state. We can see that <code>2021-01-06</code> has only a few hours of data so far, so we don't want to optimize that yet. But <code>2021-01-05</code> has all 24 hours of data, so it's ready to be optimized.</p>
<div class="highlight"><pre><span></span><code>dt.get_add_actions(flatten=True).to_pandas()[
    &quot;partition.date&quot;
].value_counts().sort_index()

2021-01-01     1
2021-01-02     1
2021-01-03     1
2021-01-04     1
2021-01-05    21
2021-01-06     4
</code></pre></div>
<p>To optimize a single partition, you can pass in a <code>partition_filters</code> argument speficying which partitions to optimize.</p>
<div class="highlight"><pre><span></span><code>dt.optimize(partition_filters=[(&quot;date&quot;, &quot;=&quot;, &quot;2021-01-05&quot;)])

{&#39;numFilesAdded&#39;: 1,
 &#39;numFilesRemoved&#39;: 21,
 &#39;filesAdded&#39;: {&#39;min&#39;: 238282,
  &#39;max&#39;: 238282,
  &#39;avg&#39;: 238282.0,
  &#39;totalFiles&#39;: 1,
  &#39;totalSize&#39;: 238282},
 &#39;filesRemoved&#39;: {&#39;min&#39;: 10244,
  &#39;max&#39;: 39000,
  &#39;avg&#39;: 11613.333333333334,
  &#39;totalFiles&#39;: 21,
  &#39;totalSize&#39;: 243880},
 &#39;partitionsOptimized&#39;: 1,
 &#39;numBatches&#39;: 1,
 &#39;totalConsideredFiles&#39;: 21,
 &#39;totalFilesSkipped&#39;: 0,
 &#39;preserveInsertionOrder&#39;: True}
</code></pre></div>
<p>This optimize operation tombstones 21 small data files and adds one file with all the existing data properly condensed.  Let’s take a look a portion of the <code>_delta_log/00000000000000000125.json</code> file, which is the transaction log entry that corresponds with this incremental optimize command.</p>
<div class="highlight"><pre><span></span><code>{
  &quot;remove&quot;: {
    &quot;path&quot;: &quot;date=2021-01-05/part-00000-41178aab-2491-488f-943d-8f03867295ee-c000.snappy.parquet&quot;,
    &quot;deletionTimestamp&quot;: 1683465499480,
    &quot;dataChange&quot;: false,
    &quot;extendedFileMetadata&quot;: null,
    &quot;partitionValues&quot;: {
      &quot;date&quot;: &quot;2021-01-05&quot;
    },
    &quot;size&quot;: 39000,
    &quot;tags&quot;: null
  }
}

{
  &quot;remove&quot;: {
    &quot;path&quot;: &quot;date=2021-01-05/101-79ae6fc9-c0cc-49ec-bb94-9aba879ac949-0.parquet&quot;,
    &quot;deletionTimestamp&quot;: 1683465499481,
    &quot;dataChange&quot;: false,
    &quot;extendedFileMetadata&quot;: null,
    &quot;partitionValues&quot;: {
      &quot;date&quot;: &quot;2021-01-05&quot;
    },
    &quot;size&quot;: 10244,
    &quot;tags&quot;: null
  }
}

…

{
  &quot;add&quot;: {
    &quot;path&quot;: &quot;date=2021-01-05/part-00000-4b020a40-c836-4a11-851f-4691370c9f3a-c000.snappy.parquet&quot;,
    &quot;size&quot;: 238282,
    &quot;partitionValues&quot;: {
      &quot;date&quot;: &quot;2021-01-05&quot;
    },
    &quot;modificationTime&quot;: 1683465499493,
    &quot;dataChange&quot;: false,
    &quot;stats&quot;: &quot;{\&quot;numRecords\&quot;:24000,\&quot;minValues\&quot;:{\&quot;value\&quot;:0.00005581532256615507,\&quot;timestamp\&quot;:\&quot;2021-01-05T00:00:00.000Z\&quot;},\&quot;maxValues\&quot;:{\&quot;timestamp\&quot;:\&quot;2021-01-05T23:00:00.000Z\&quot;,\&quot;value\&quot;:0.9999911402868216},\&quot;nullCount\&quot;:{\&quot;timestamp\&quot;:0,\&quot;value\&quot;:0}}&quot;,
    &quot;tags&quot;: null
  }
}
</code></pre></div>
<p>The trasaction log indicates that many files have been tombstoned and one file is added, as expected.</p>
<p>The Delta Lake optimize command “removes” data by marking the data files as removed in the transaction log.  The optimize command doesn’t physically delete the Parquet file from storage.  Optimize performs a “logical remove” not a “physical remove”.</p>
<p>Delta Lake uses logical operations so you can time travel back to earlier versions of your data.  You can vacuum your Delta table to physically remove Parquet files from storage if you don’t need to time travel and don’t want to pay to store the tombstoned files.</p>
<h2 id="vacuuming-after-optimizing">Vacuuming after optimizing</h2>
<p>The vacuum command deletes all files from storage that are marked for removal in the transaction log and older than the retention period which is 7 days by default.</p>
<p>It’s normally a good idea to have a retention period of at least 7 days.  For purposes of this example, we will set the retention period to zero, just so you can see how the files get removed from storage.  Adjusting the retention period in this manner isn’t recommended for production use cases.</p>
<p>Let’s run the vacuum command:</p>
<div class="highlight"><pre><span></span><code>dt.vacuum(retention_hours=0, enforce_retention_duration=False, dry_run=False)
</code></pre></div>
<p>The command returns a list of all the files that are removed from storage:</p>
<div class="highlight"><pre><span></span><code>[&#39;date=2021-01-02/39-a98680f2-0e0e-4f26-a491-18b183f9eb05-0.parquet&#39;,
 &#39;date=2021-01-02/41-e96bc8bb-c571-484c-b534-e897424fb7da-0.parquet&#39;,
 …
 &#39;date=2021-01-01/0-cfe227c6-edd9-4369-a1b0-db4559a2e693-0.parquet&#39;,
 &#39;date=2021-01-01/18-ded53418-172b-4e40-bf2e-7c8142e71bd1-0.parquet&#39;]
</code></pre></div>
<p>Let’s look at the content of the Delta table now that all the really small files have been removed from storage:</p>
<div class="highlight"><pre><span></span><code>observation_data
├── _delta_log
│   ├── 00000000000000000000.json
│   ├── 00000000000000000001.json
│   ├── …
│   ├── 00000000000000000124.json
│   └── 00000000000000000125.json
├── date=2021-01-01
│   └── part-00000-31e3df5a-8bbe-425c-b85d-77794f922837-c000.snappy.parquet
├── date=2021-01-02
│   └── part-00000-8af07878-b179-49ce-a900-d58595ffb60a-c000.snappy.parquet
├── date=2021-01-03
│   └── part-00000-5e980864-b32f-4686-a58d-a75fae455c1e-c000.snappy.parquet
├── date=2021-01-04
│   └── part-00000-1e82d23b-084d-47e3-9790-d68289c39837-c000.snappy.parquet
├── date=2021-01-05
│   └── part-00000-4b020a40-c836-4a11-851f-4691370c9f3a-c000.snappy.parquet
└── date=2021-01-06
    ├── 121-0ecb5d70-4a28-4cd4-b2d2-89ee2285eaaa-0.parquet
    ├── 122-6b2d2758-9154-4392-b287-fe371ee507ec-0.parquet
    ├── 123-551d318f-4968-441f-83fc-89f98cd15daf-0.parquet
    └── 124-287309d3-662e-449d-b4da-2e67b7cc0557-0.parquet
</code></pre></div>
<p>All the partitions only contain a single file now, except for the <code>date=2021-01-06</code> partition that has not been compacted yet.</p>
<p>An entire partition won’t necessarily get compacted to a single data file when optimize is run.  Each partition has data files that are condensed to the target file size.</p>
<h2 id="what-causes-the-small-file-problem">What causes the small file problem?</h2>
<p>Delta tables can accumulate small files for a variety of reasons:</p>
<ul>
<li>User error: users can accidentally write files that are too small.  Users should sometimes repartition in memory before writing to disk to avoid appending files that are too small.</li>
<li>Frequent appends: systems that append more often tend to append more smaller files.  A pipeline that appends every minute will generally generate ten times as many small files compared to a system that appends every ten minutes.</li>
<li>Appending to partitioned data lakes with high cardinality columns can also cause small files.  If you append every hour to a table that’s partitioned on a column with 1,000 distinct values, then every append could create 1,000 new files.  Partitioning by date avoids this problem because the data isn’t split up across partitions in this manner.  </li>
</ul>
<h2 id="conclusion">Conclusion</h2>
<p>This page showed you how to create a Delta table with many small files, compact the small files into larger files with optimize, and remove the tombstoned files from storage with vacuum.</p>
<p>You also learned about how to incrementally optimize partitioned Delta tables, so you only compact newly added data.</p>
<p>An excessive number of small files slows down Delta table queries, so periodic compaction is important.  Make sure to properly maintain your Delta tables, so performance does not degrade over time.</p>





                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../../deleting-rows-from-delta-lake-table/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Deleting rows from a table">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Deleting rows from a table
              </div>
            </div>
          </a>
        
        
          
          <a href="../delta-lake-z-order/" class="md-footer__link md-footer__link--next" aria-label="Next: Z Order">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Z Order
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tracking", "navigation.instant", "navigation.tabs", "navigation.tabs.sticky", "navigation.footer", "content.tabs.link"], "search": "../../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.aecac24b.min.js"></script>
      
    
  </body>
</html>